import{Color as ue,DataTexture as Ae,DoubleSide as De,Matrix4 as Ge,Mesh as Be,NearestFilter as ce,PlaneBufferGeometry as he,RGBAFormat as Ve,RepeatWrapping as le,ShaderMaterial as Ne,Uniform as c,UnsignedByteType as We,UVMapping as je,Vector2 as O,Vector4 as ke}from"three";import{Plane as $,Ray as Se,Vector3 as D}from"three";var Ze=2*Math.PI,Je=180/Math.PI,Ke=Math.PI/180;var Qe=new Se,et=new $(new D(0,-1,0),1),tt=new $(new D(0,-1,0),1),nt=new D;var rt=Math.PI*2,ot=Math.PI*3;var ve=(Math.sqrt(5)+1)*.5-1,it=ve*Math.PI*2;var Y=(n,t,e=!1)=>{let r=n.indexOf(t);if(r!==-1)n.splice(r,1);else if(e)throw new Error("could not find value in array");return t};var G=class{get listenerCount(){return this.listeners.length}obj;propName;value;listeners;constructor(t,e){this.propName=e,this.listeners=[],this.setValue=this.setValue.bind(this),this.attach(t)}attach(t){this.obj&&this.release(),this.obj=t;let e=this.obj[this.propName];Object.defineProperty(t,this.propName,{configurable:!0,set:this.setValue,get:()=>this.value}),this.setValue(e)}release(){Object.defineProperty(this.obj,this.propName,{value:this.value,writable:!0})}hasListener(t){return this.listeners.indexOf(t)!==-1}addListener(t,e=!0){e&&t(this.value,void 0),this.listeners.push(t)}removeListener(t){Y(this.listeners,t)}setValue(t){if(this.value===t)return;let e=this.value;this.value=t;for(let r of this.listeners)r(t,e)}},S=new Map;function be(n){return S.has(n)||S.set(n,new Map),S.get(n)}function we(n,t){let e=be(n);return e.has(t)||e.set(t,new G(n,t)),e.get(t)}function _(n,t,e,r=!0){we(n,t).addListener(e,r)}function T(n,t,e){let r=S.get(n);if(r){let o=r.get(t);o&&(o.removeListener(e),o.listenerCount===0&&(o.release(),r.delete(t))),r.size===0&&S.delete(n)}}import{DataTexture as Pe,RGBAFormat as _e,UnsignedByteType as Me}from"three";var B;function Z(){if(!B){let e=new Uint8Array(64);for(let r=0;r<64;r++)e[r]=0;B=new Pe(e,4,4,_e,Me)}return B}var J="precision highp float;uniform sampler2D fontTexture;uniform sampler2D layoutTexture;uniform vec3 color;uniform vec3 strokeColor;uniform vec2 fontSizeInChars;varying vec2 vUv;varying vec2 vUvCharCols;void main(){vec4 layoutTexel=texture2D(layoutTexture,vec2(vUv.x,1.0-vUv.y));vec2 fontCharIndices=layoutTexel.xz*vec2(255.0001);vec4 layoutCharUv=fract(vUvCharCols).xyxy;layoutCharUv.xz=fract(layoutCharUv.xz-layoutTexel.yw);vec2 tA=mod(fontCharIndices,fontSizeInChars.x);vec2 tB=vec2(fontSizeInChars.y-1.0)-floor(fontCharIndices/fontSizeInChars.x);vec4 packedAB=vec4(tA.x,tB.x,tA.y,tB.y);vec4 fontCharIndexUv=(layoutCharUv+packedAB)/fontSizeInChars.xyxy;vec4 texel=texture2D(fontTexture,fontCharIndexUv.xy);vec4 texel2=texture2D(fontTexture,fontCharIndexUv.zw);vec4 final=max(texel,texel2);if(final.a<0.5)discard;vec3 finalColor=mix(strokeColor,color,final.r);gl_FragColor=vec4(finalColor.rgb,1.0);}";import{Color as h}from"three";var K=new h(0),Q=new h(16777215),gt=new h(6750054),Tt=new h(2273279),ee=new h(6750054),Ct=new h(16711680),yt=new h(16050242);import{NearestFilter as re}from"three";import{FileLoader as Ie,LoadingManager as Fe,TextureLoader as Ue}from"three";var te=new Fe,V;function Ee(){return V||(V=new Ie(te)),V}var N;function Re(){return N||(N=new Ue(te)),N}async function W(n){return new Promise((t,e)=>Ee().load(n,r=>t(r),void 0,e))}var v=new Map;async function ne(n,t){let e;return v.has(n)?e=new Promise((r,o)=>{v.get(n).push(r)}):e=new Promise((r,o)=>{v.set(n,[r]);let I=C=>{C.name=n,t!==void 0&&(C.flipY=t),v.get(n).forEach(q=>q(C)),v.delete(n)};Re().load(n,I,void 0,o)}),e}function j(n,t){return`pixelFonts/${n}.${t}`}var M=class{constructor(t,e=7){this.name=t;this.maxCharPixelWidth=e}font;pixelWidths;texture;_initd=!1;async init(){if(this._initd)return;this._initd=!0,this.texture=await ne(j(this.name,"png")),this.texture.minFilter=re,this.texture.magFilter=re;let t=(await W(j(this.name+"_char-widths","txt"))).split(`
`).join(""),e=[];for(let r=0;r<t.length;r++)e[r]=parseInt(t[r]);this.pixelWidths=e,this.font=(await W(j(this.name,"txt"))).split(`
`).join("")}},oe={cdogs_font_7x8:new M("cdogs_font_7x8",7)};var ie={fontFace:oe.cdogs_font_7x8,color:Q,letterSpacing:-1,strokeColor:K,scaleDownToPhysicalSize:!0,screenSpace:!1,constantSizeOnScreen:!1},Le={...ie,color:ee},se={generic:ie,title:Le};var ae=`#ifdef USE_SCREENSPACE
uniform vec2 offset;uniform float prescale;uniform vec4 clipSpacePosition;uniform vec2 pixelSizeInClipSpace;
#endif
varying vec2 vUv;varying vec2 vUvCharCols;uniform vec2 layoutSizeInChars;void main(){vUv=uv;vUvCharCols=uv*layoutSizeInChars;
#ifdef USE_SCREENSPACE
vec2 finalOffset=(offset+position.xy)*pixelSizeInClipSpace*prescale;
#ifdef CONSTANT_SIZE_ON_SCREEN
finalOffset*=clipSpacePosition.w;
#endif
gl_Position=clipSpacePosition;gl_Position.xy+=finalOffset;
#else
gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
#endif
}`;var fe=new Ge,k=[];function He(n){if(!n)return-1;let t=k.indexOf(n);return t===-1?(k.push(n),k.length-1):t}var Xe=2048,H=class extends Be{constructor(e="",r=se.generic,o,I,C=!0){super(xe(e,r),qe(r));this._text=e;this.settings=r;this.onMeasurementsUpdated=o;this.onCharSizeUpdated=I;this.optimizeRenderOrder=C;_(r,"fontFace",this.onFontFaceChange,!0)}width=0;height=0;dirty=!1;livePropObject;livePropName;_fontFace;_newTexture;_newFontString;get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this.dirty=!0)}onFontFaceChange=(e,r)=>{r&&(T(r,"texture",this.onFontTextureUpdate),T(r,"font",this.onFontUpdate)),_(e,"texture",this.onFontTextureUpdate),_(e,"font",this.onFontUpdate),e.init(),this._fontFace=e};onFontTextureUpdate=e=>{this._newTexture=e,this.dirty=!0};onFontUpdate=e=>{this._newFontString=e,this.dirty=!0};onBeforeRender=(e,r,o,I,C,q)=>{if(this.settings.screenSpace){let l=this.material.uniforms.clipSpacePosition.value;fe.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld).premultiply(o.projectionMatrix),l.set(0,0,0,1).applyMatrix4(fe)}if(this.dirty){this.dirty=!1,this.regenerateGeometry();let l=this.material;if(this._newTexture){this.optimizeRenderOrder&&(this.renderOrder=this.renderOrder||100+He(this._newTexture)),l.uniforms.fontTexture.value=this._newTexture;let d=this._newTexture.image;l.uniforms.fontSizeInChars.value.set(d.width/7,d.height/8),this._newTexture=void 0}if(this._newFontString&&this._text){let d=this.text.split(`
`).slice(0,Xe),m=d.length,F=this.settings.fontFace,U=F.maxCharPixelWidth,E=F.font,R=F.pixelWidths,y=-this.settings.letterSpacing,L=E.indexOf("\u25A1");if(L===-1)throw new Error("Please include this character \u25A1 in your font, to stand in for other missing characters");let z="",ge=d.map(i=>{let a=0;for(let s=0;s<i.length;s++){let u=i[s];if(u==null)continue;let b=E.indexOf(u);b===-1?(a+=R[L]-y,z.includes(u)||(z+=u)):a+=R[b]-y}return a+y});console.warn("Characters in text not found in font: "+z);let g=ge.reduce((i,a)=>Math.max(i,a),0),Te=g*m,f=new Uint8Array(Te*4);for(let i=0;i<m;i++){let a=i*g,s=0,u=d[i],b=u.length;for(let w=0;w<=b;w++){let A=u[w],Ce=u[w-1];if(!A&&!Ce)continue;let P=E.indexOf(A);P===-1&&A!==void 0&&(P=L);let ye=R[P];for(let p=0;p<ye;p++){let x=(a+s)*4;f[x]=P,f[x+1]=(s-p)/U%1*255,s++}s-=y;for(let p=0;p<y;p++){let x=(a+s+p)*4;f[x+2]=f[x],f[x+3]=f[x+1]}}}l.uniforms.layoutSizeInChars.value.set(g/U,m),l.uniforms.layoutSizeInCharColumns.value.set(g,m),l.uniforms.layoutTexture.value=new Ae(f,g,m,Ve,We,je,le,le,ce,ce),this._newFontString=void 0,this.onCharSizeUpdated&&this.onCharSizeUpdated(g/U,m)}}};updateText=(e="")=>{this.text=`${e}`};onRemove(){T(this.settings,"fontFace",this.onFontFaceChange),this._fontFace&&(T(this._fontFace,"texture",this.onFontTextureUpdate),T(this._fontFace,"font",this.onFontUpdate))}regenerateGeometry(){this.geometry=xe(this._text,this.settings),this.updateMeasurements()}updateMeasurements(){let e=this.geometry.boundingBox;this.width=e.max.x-e.min.x,this.height=Math.abs(e.max.y-e.min.y),this.userData.resolution=new O(this.width,this.height),this.onMeasurementsUpdated&&this.onMeasurementsUpdated(this)}},qe=n=>{let t={layoutTexture:new c(Z()),fontTexture:new c(n.fontFace.texture),color:new c(new ue(n.color)),strokeColor:new c(new ue(n.strokeColor)),fontSizeInChars:new c(new O(1,1)),layoutSizeInChars:new c(new O(1,1)),layoutSizeInCharColumns:new c(new O(1,1))},e=t;if(n.screenSpace)if(e.clipSpacePosition=new c(new ke),n.pixelSizeInClipSpaceUniform)e.pixelSizeInClipSpace=n.pixelSizeInClipSpaceUniform;else throw new Error("You must provide a pixelSizeInClipSpaceUniform for screenSpace mode");return new Ne({defines:{USE_SCREENSPACE:n.screenSpace,CONSTANT_SIZE_ON_SCREEN:n.constantSizeOnScreen},uniforms:t,vertexShader:ae,fragmentShader:J,depthWrite:!0,side:De})},de=new he(.001,.001);de.computeBoundingBox();var X=new he(1,1),me=X.attributes.position,pe=me.array;for(let n=0;n<me.count;n++){let t=n*3;pe[t]+=.5,pe[t+1]-=.5}X.computeBoundingBox();var xe=(n,t)=>t.fontFace.font&&n?X:de;export{H as default};
//# sourceMappingURL=index.js.map
