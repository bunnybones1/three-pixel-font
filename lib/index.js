import{Color as ce,DataTexture as De,DoubleSide as Ge,Matrix4 as Be,Mesh as Ve,NearestFilter as le,PlaneBufferGeometry as de,RGBAFormat as Ne,RepeatWrapping as fe,ShaderMaterial as We,Uniform as l,UnsignedByteType as je,UVMapping as ke,Vector2 as I,Vector4 as He}from"three";import{Plane as Y,Ray as be,Vector3 as D}from"three";var Je=2*Math.PI,Ke=180/Math.PI,Qe=Math.PI/180;var et=new be,tt=new Y(new D(0,-1,0),1),nt=new Y(new D(0,-1,0),1),rt=new D;var ot=Math.PI*2,it=Math.PI*3;var ve=(Math.sqrt(5)+1)*.5-1,st=ve*Math.PI*2;var Z=(n,t,e=!1)=>{let r=n.indexOf(t);if(r!==-1)n.splice(r,1);else if(e)throw new Error("could not find value in array");return t};var G=class{get listenerCount(){return this.listeners.length}obj;propName;value;listeners;constructor(t,e){this.propName=e,this.listeners=[],this.setValue=this.setValue.bind(this),this.attach(t)}attach(t){this.obj&&this.release(),this.obj=t;let e=this.obj[this.propName];Object.defineProperty(t,this.propName,{configurable:!0,set:this.setValue,get:()=>this.value}),this.setValue(e)}release(){Object.defineProperty(this.obj,this.propName,{value:this.value,writable:!0})}hasListener(t){return this.listeners.indexOf(t)!==-1}addListener(t,e=!0){e&&t(this.value,void 0),this.listeners.push(t)}removeListener(t){Z(this.listeners,t)}setValue(t){if(this.value===t)return;let e=this.value;this.value=t;for(let r of this.listeners)r(t,e)}},b=new Map;function we(n){return b.has(n)||b.set(n,new Map),b.get(n)}function Pe(n,t){let e=we(n);return e.has(t)||e.set(t,new G(n,t)),e.get(t)}function O(n,t,e,r=!0){Pe(n,t).addListener(e,r)}function T(n,t,e){let r=b.get(n);if(r){let o=r.get(t);o&&(o.removeListener(e),o.listenerCount===0&&(o.release(),r.delete(t))),r.size===0&&b.delete(n)}}import{DataTexture as _e,RGBAFormat as Me,UnsignedByteType as Oe}from"three";var B;function J(){if(!B){let e=new Uint8Array(64);for(let r=0;r<64;r++)e[r]=0;B=new _e(e,4,4,Me,Oe)}return B}var K="precision highp float;uniform sampler2D fontTexture;uniform sampler2D layoutTexture;uniform vec3 color;uniform vec3 strokeColor;uniform vec2 fontSizeInChars;varying vec2 vUv;varying vec2 vUvCharCols;void main(){vec4 layoutTexel=texture2D(layoutTexture,vec2(vUv.x,1.0-vUv.y));vec2 fontCharIndices=layoutTexel.xz*vec2(255.0001);vec4 layoutCharUv=fract(vUvCharCols).xyxy;layoutCharUv.xz=fract(layoutCharUv.xz-layoutTexel.yw);vec2 tA=mod(fontCharIndices,fontSizeInChars.x);vec2 tB=vec2(fontSizeInChars.y-1.0)-floor(fontCharIndices/fontSizeInChars.x);vec4 packedAB=vec4(tA.x,tB.x,tA.y,tB.y);vec4 fontCharIndexUv=(layoutCharUv+packedAB)/fontSizeInChars.xyxy;vec4 texel=texture2D(fontTexture,fontCharIndexUv.xy);vec4 texel2=texture2D(fontTexture,fontCharIndexUv.zw);vec4 final=max(texel,texel2);if(final.a<0.5)discard;vec3 finalColor=mix(strokeColor,color,final.r);gl_FragColor=vec4(finalColor.rgb,1.0);}";import{Color as x}from"three";var Q=new x(0),ee=new x(16777215),Tt=new x(6750054),Ct=new x(2273279),te=new x(6750054),yt=new x(16711680),St=new x(16050242);import{NearestFilter as oe}from"three";import{FileLoader as Fe,LoadingManager as Ue,TextureLoader as Ee}from"three";var ne=new Ue,V;function Re(){return V||(V=new Fe(ne)),V}var N;function Le(){return N||(N=new Ee(ne)),N}async function W(n){return new Promise((t,e)=>Re().load(n,r=>t(r),void 0,e))}var v=new Map;async function re(n,t){let e;return v.has(n)?e=new Promise((r,o)=>{v.get(n).push(r)}):e=new Promise((r,o)=>{v.set(n,[r]);let F=C=>{C.name=n,t!==void 0&&(C.flipY=t),v.get(n).forEach(q=>q(C)),v.delete(n)};Le().load(n,F,void 0,o)}),e}function j(n,t){return`${n}.${t}`}var w=class{constructor(t,e=7,r=8){this.name=t;this.maxCharPixelWidth=e;this.charPixelHeight=r}font;pixelWidths;texture;_initd=!1;async init(){if(this._initd)return;this._initd=!0,this.texture=await re(j(this.name,"png")),this.texture.minFilter=oe,this.texture.magFilter=oe;let t=(await W(j(this.name+"_char-widths","txt"))).split(`
`).join(""),e=[];for(let r=0;r<t.length;r++)e[r]=parseInt(t[r]);this.pixelWidths=e,this.font=(await W(j(this.name,"txt"))).split(`
`).join("")}},ie={cdogs_font_7x8:new w("pixelFonts/cdogs_font_7x8",7,8),good_neighbors:new w("pixelFonts/good_neighbors",11,16)};var se={fontFace:ie.cdogs_font_7x8,color:ee,letterSpacing:-1,strokeColor:Q,scaleDownToPhysicalSize:!0,screenSpace:!1,constantSizeOnScreen:!1},ze={...se,color:te},ae={generic:se,title:ze};var ue=`#ifdef USE_SCREENSPACE
uniform vec2 offset;uniform float prescale;uniform vec4 clipSpacePosition;uniform vec2 pixelSizeInClipSpace;
#endif
varying vec2 vUv;varying vec2 vUvCharCols;uniform vec2 layoutSizeInChars;void main(){vUv=uv;vUvCharCols=uv*layoutSizeInChars;
#ifdef USE_SCREENSPACE
vec2 finalOffset=(offset+position.xy)*pixelSizeInClipSpace*prescale;
#ifdef CONSTANT_SIZE_ON_SCREEN
finalOffset*=clipSpacePosition.w;
#endif
gl_Position=clipSpacePosition;gl_Position.xy+=finalOffset;
#else
gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
#endif
}`;var pe=new Be,k=[];function Xe(n){if(!n)return-1;let t=k.indexOf(n);return t===-1?(k.push(n),k.length-1):t}var qe=2048,H=class extends Ve{constructor(e="",r=ae.generic,o,F,C=!0){super(xe(e,r),$e(r));this._text=e;this.settings=r;this.onMeasurementsUpdated=o;this.onCharSizeUpdated=F;this.optimizeRenderOrder=C;O(r,"fontFace",this.onFontFaceChange,!0)}width=0;height=0;dirty=!1;livePropObject;livePropName;_fontFace;_newTexture;_newFontString;get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this.dirty=!0)}onFontFaceChange=(e,r)=>{r&&(T(r,"texture",this.onFontTextureUpdate),T(r,"font",this.onFontUpdate)),O(e,"texture",this.onFontTextureUpdate),O(e,"font",this.onFontUpdate),e.init(),this._fontFace=e};onFontTextureUpdate=e=>{this._newTexture=e,this.dirty=!0};onFontUpdate=e=>{this._newFontString=e,this.dirty=!0};onBeforeRender=(e,r,o,F,C,q)=>{if(this.settings.screenSpace){let a=this.material.uniforms.clipSpacePosition.value;pe.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld).premultiply(o.projectionMatrix),a.set(0,0,0,1).applyMatrix4(pe)}if(this.dirty){this.dirty=!1,this.regenerateGeometry();let a=this.material;if(this._newTexture&&(this.optimizeRenderOrder&&(this.renderOrder=this.renderOrder||100+Xe(this._newTexture)),a.uniforms.fontTexture.value=this._newTexture,this._newTexture=void 0),this._newFontString&&this._text){let U=this.text.split(`
`).slice(0,qe),d=U.length,y=this.settings.fontFace,m=y.maxCharPixelWidth,E=y.font,R=y.pixelWidths,S=-this.settings.letterSpacing,$=a.uniforms.fontTexture.value.image;a.uniforms.fontSizeInChars.value.set($.width/y.maxCharPixelWidth,$.height/y.charPixelHeight);let L=E.indexOf("\u25A1");if(L===-1)throw new Error("Please include this character \u25A1 in your font, to stand in for other missing characters");let z="",Te=U.map(i=>{let u=0;for(let s=0;s<i.length;s++){let c=i[s];if(c==null)continue;let P=E.indexOf(c);P===-1?(u+=m-R[L]-S,z.includes(c)||(z+=c)):u+=m-R[P]-S}return u+S});console.warn("Characters in text not found in font: "+z);let g=Te.reduce((i,u)=>Math.max(i,u),0),Ce=g*d,f=new Uint8Array(Ce*4);for(let i=0;i<d;i++){let u=i*g,s=0,c=U[i],P=c.length;for(let _=0;_<=P;_++){let A=c[_],ye=c[_-1];if(!A&&!ye)continue;let M=E.indexOf(A);M===-1&&A!==void 0&&(M=L);let Se=m-R[M];for(let p=0;p<Se;p++){let h=(u+s)*4;f[h]=M,f[h+1]=(s-p)/m%1*255,s++}s-=S;for(let p=0;p<S;p++){let h=(u+s+p)*4;f[h+2]=f[h],f[h+3]=f[h+1]}}}a.uniforms.layoutSizeInChars.value.set(g/m,d),a.uniforms.layoutSizeInCharColumns.value.set(g,d),a.uniforms.layoutTexture.value=new De(f,g,d,Ne,je,ke,fe,fe,le,le),this._newFontString=void 0,this.onCharSizeUpdated&&this.onCharSizeUpdated(g/m,d)}}};updateText=(e="")=>{this.text=`${e}`};onRemove(){T(this.settings,"fontFace",this.onFontFaceChange),this._fontFace&&(T(this._fontFace,"texture",this.onFontTextureUpdate),T(this._fontFace,"font",this.onFontUpdate))}regenerateGeometry(){this.geometry=xe(this._text,this.settings),this.updateMeasurements()}updateMeasurements(){let e=this.geometry.boundingBox;this.width=e.max.x-e.min.x,this.height=Math.abs(e.max.y-e.min.y),this.userData.resolution=new I(this.width,this.height),this.onMeasurementsUpdated&&this.onMeasurementsUpdated(this)}},$e=n=>{let t={layoutTexture:new l(J()),fontTexture:new l(n.fontFace.texture),color:new l(new ce(n.color)),strokeColor:new l(new ce(n.strokeColor)),fontSizeInChars:new l(new I(1,1)),layoutSizeInChars:new l(new I(1,1)),layoutSizeInCharColumns:new l(new I(1,1))},e=t;if(n.screenSpace)if(e.clipSpacePosition=new l(new He),n.pixelSizeInClipSpaceUniform)e.pixelSizeInClipSpace=n.pixelSizeInClipSpaceUniform;else throw new Error("You must provide a pixelSizeInClipSpaceUniform for screenSpace mode");return new We({defines:{USE_SCREENSPACE:n.screenSpace,CONSTANT_SIZE_ON_SCREEN:n.constantSizeOnScreen},uniforms:t,vertexShader:ue,fragmentShader:K,depthWrite:!0,side:Ge})},me=new de(.001,.001);me.computeBoundingBox();var X=new de(1,1),ge=X.attributes.position,he=ge.array;for(let n=0;n<ge.count;n++){let t=n*3;he[t]+=.5,he[t+1]-=.5}X.computeBoundingBox();var xe=(n,t)=>t.fontFace.font&&n?X:me;export{H as default};
//# sourceMappingURL=index.js.map
