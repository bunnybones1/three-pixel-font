import{Color as ae,DataTexture as Ee,Matrix4 as Le,Mesh as Ve,NearestFilter as se,PlaneBufferGeometry as pe,RGBAFormat as De,RepeatWrapping as ue,Uniform as o,UnsignedByteType as Ge,UVMapping as Re,Vector2 as w,Vector4 as Be,RawShaderMaterial as Ne}from"three";import{Plane as J,Ray as ye,Vector3 as V}from"three";var $e=2*Math.PI,Ze=180/Math.PI,Je=Math.PI/180;var Xe=new ye,Ye=new J(new V(0,-1,0),1),Ke=new J(new V(0,-1,0),1),Qe=new V;var et=Math.PI*2,tt=Math.PI*3;var ve=(Math.sqrt(5)+1)*.5-1,nt=ve*Math.PI*2;var X=(t,n,e=!1)=>{let r=t.indexOf(n);if(r!==-1)t.splice(r,1);else if(e)throw new Error("could not find value in array");return n};var D=class{get listenerCount(){return this.listeners.length}obj;propName;value;listeners;constructor(n,e){this.propName=e,this.listeners=[],this.setValue=this.setValue.bind(this),this.attach(n)}attach(n){this.obj&&this.release(),this.obj=n;let e=this.obj[this.propName];Object.defineProperty(n,this.propName,{configurable:!0,set:this.setValue,get:()=>this.value}),this.setValue(e)}release(){Object.defineProperty(this.obj,this.propName,{value:this.value,writable:!0})}hasListener(n){return this.listeners.indexOf(n)!==-1}addListener(n,e=!0){e&&n(this.value,void 0),this.listeners.push(n)}removeListener(n){X(this.listeners,n)}setValue(n){if(this.value===n)return;let e=this.value;this.value=n;for(let r of this.listeners)r(n,e)}},b=new Map;function be(t){return b.has(t)||b.set(t,new Map),b.get(t)}function Ce(t,n){let e=be(t);return e.has(n)||e.set(n,new D(t,n)),e.get(n)}function I(t,n,e,r=!0){Ce(t,n).addListener(e,r)}function g(t,n,e){let r=b.get(t);if(r){let i=r.get(n);i&&(i.removeListener(e),i.listenerCount===0&&(i.release(),r.delete(n))),r.size===0&&b.delete(t)}}import{DataTexture as Se,RGBAFormat as we,UnsignedByteType as Pe}from"three";var G;function Y(){if(!G){let e=new Uint8Array(64);for(let r=0;r<64;r++)e[r]=0;G=new Se(e,4,4,we,Pe)}return G}var K="precision highp float;uniform sampler2D fontTexture;uniform sampler2D layoutTexture;uniform vec3 color;uniform vec3 strokeColor;uniform vec2 fontSizeInChars;varying vec2 vUv;varying vec2 vUvCharCols;void main(){vec4 layoutTexel=texture2D(layoutTexture,vec2(vUv.x,1.0-vUv.y));vec2 fontCharIndices=layoutTexel.xz*vec2(255.0001);vec4 layoutCharUv=fract(vUvCharCols).xyxy;layoutCharUv.xz=fract(layoutCharUv.xz-layoutTexel.yw);vec2 tA=mod(fontCharIndices,fontSizeInChars.x);vec2 tB=vec2(fontSizeInChars.y-1.0)-floor(fontCharIndices/fontSizeInChars.x);vec4 packedAB=vec4(tA.x,tB.x,tA.y,tB.y);vec4 fontCharIndexUv=(layoutCharUv+packedAB)/fontSizeInChars.xyxy;vec4 texel=texture2D(fontTexture,fontCharIndexUv.xy);vec4 texel2=texture2D(fontTexture,fontCharIndexUv.zw);vec4 final=max(texel,texel2);if(final.a<0.5)discard;vec3 finalColor=mix(strokeColor,color,final.r);gl_FragColor=vec4(finalColor.rgb,1.0);}";import{Color as j}from"three";import{NearestFilter as te}from"three";import{FileLoader as _e,LoadingManager as Ie,TextureLoader as Ue}from"three";var Q=new Ie,R;function Fe(){return R||(R=new _e(Q)),R}var B;function Oe(){return B||(B=new Ue(Q)),B}async function N(t){return new Promise((n,e)=>Fe().load(t,r=>n(r),void 0,e))}var C=new Map;async function ee(t,n){let e;return C.has(t)?e=new Promise((r,i)=>{C.get(t).push(r)}):e=new Promise((r,i)=>{C.set(t,[r]);let U=T=>{T.name=t,n!==void 0&&(T.flipY=n),C.get(t).forEach($=>$(T)),C.delete(t)};Oe().load(t,U,void 0,i)}),e}function W(t,n){return`${t}.${n}`}var S=class{constructor(n,e=7,r=8){this.name=n;this.maxCharPixelWidth=e;this.charPixelHeight=r}font;pixelWidths;texture;_initd=!1;async init(){if(this._initd)return;this._initd=!0,this.texture=await ee(W(this.name,"png")),this.texture.minFilter=te,this.texture.magFilter=te;let n=(await N(W(this.name+"_char-widths","txt"))).split(`
`).join(""),e=[];for(let r=0;r<n.length;r++)e[r]=parseInt(n[r]);this.pixelWidths=e,this.font=(await N(W(this.name,"txt"))).split(`
`).join("")}},ne={cdogs_font_7x8:new S("pixelFonts/cdogs_font_7x8",7,8),good_neighbors:new S("pixelFonts/good_neighbors",11,16)};var re={fontFace:ne.cdogs_font_7x8,align:0,vAlign:0,color:new j(1,1,1),letterSpacing:-1,strokeColor:new j(0,0,0),scaleDownToPhysicalSize:!0,screenSpace:!1,constantSizeOnScreen:!1,prescale:1},ze={...re,color:new j(.75,1,0)},ie={generic:re,title:ze};var oe=`uniform vec2 alignment;
#ifdef USE_SCREENSPACE
uniform float prescale;uniform vec4 clipSpacePosition;uniform vec2 pixelSizeInClipSpace;
#else
uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;
#endif
attribute vec3 position;attribute vec2 uv;varying vec2 vUv;varying vec2 vUvCharCols;uniform vec2 layoutSizeInChars;void main(){vUv=uv;vUvCharCols=uv*layoutSizeInChars;
#ifdef USE_SCREENSPACE
vec2 finalOffset=(position.xy-alignment)*pixelSizeInClipSpace*prescale*layoutSizeInChars;
#ifdef CONSTANT_SIZE_ON_SCREEN
finalOffset*=clipSpacePosition.w;
#endif
gl_Position=clipSpacePosition;gl_Position.xy+=finalOffset;
#else
vec3 pos=position;pos.xy-=alignment;gl_Position=projectionMatrix*modelViewMatrix*vec4(pos,1.0);
#endif
}`;var ce=new Le,k=[];function We(t){if(!t)return-1;let n=k.indexOf(t);return n===-1?(k.push(t),k.length-1):n}var je=2048,H=class extends Ve{constructor(e="",r=ie.generic,i,U,T=!0){super(fe(e,r),ke(r));this._text=e;this.settings=r;this.onMeasurementsUpdated=i;this.onCharSizeUpdated=U;this.optimizeRenderOrder=T;I(r,"fontFace",this.onFontFaceChange,!0)}width=0;height=0;dirty=!1;livePropObject;livePropName;_fontFace;_newTexture;_newFontString;get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this.dirty=!0)}onFontFaceChange=(e,r)=>{r&&(g(r,"texture",this.onFontTextureUpdate),g(r,"font",this.onFontUpdate)),I(e,"texture",this.onFontTextureUpdate),I(e,"font",this.onFontUpdate),e.init(),this._fontFace=e};onFontTextureUpdate=e=>{this._newTexture=e,this.dirty=!0};onFontUpdate=e=>{this._newFontString=e,this.dirty=!0};onBeforeRender=(e,r,i,U,T,$)=>{if(this.settings.screenSpace){let u=this.material.uniforms.clipSpacePosition.value;ce.multiplyMatrices(i.matrixWorldInverse,this.matrixWorld).premultiply(i.projectionMatrix),u.set(0,0,0,1).applyMatrix4(ce)}if(this.dirty){this.dirty=!1,this.regenerateGeometry();let u=this.material;if(this._newTexture&&(this.optimizeRenderOrder&&(this.renderOrder=this.renderOrder||100+We(this._newTexture)),u.uniforms.fontTexture.value=this._newTexture,this._newTexture=void 0),this._newFontString&&this._text){let F=this.text.split(`
`).slice(0,je),x=F.length,y=this.settings.fontFace,m=y.maxCharPixelWidth,O=y.font,z=y.pixelWidths,v=-this.settings.letterSpacing,Z=u.uniforms.fontTexture.value.image;u.uniforms.fontSizeInChars.value.set(Z.width/y.maxCharPixelWidth,Z.height/y.charPixelHeight);let A=O.indexOf("\u25A1");if(A===-1)throw new Error("Please include this character \u25A1 in your font, to stand in for other missing characters");let E="",me=F.map(a=>{let c=0;for(let s=0;s<a.length;s++){let l=a[s];if(l==null)continue;let P=O.indexOf(l);P===-1?(c+=m-z[A]-v,E.includes(l)||(E+=l)):c+=m-z[P]-v}return c+v});console.warn("Characters in text not found in font: "+E);let d=me.reduce((a,c)=>Math.max(a,c),0),de=d*x,f=new Uint8Array(de*4);for(let a=0;a<x;a++){let c=a*d,s=0,l=F[a],P=l.length;for(let M=0;M<=P;M++){let L=l[M],ge=l[M-1];if(!L&&!ge)continue;let _=O.indexOf(L);_===-1&&L!==void 0&&(_=A);let Te=m-z[_];for(let p=0;p<Te;p++){let h=(c+s)*4;f[h]=_,f[h+1]=(s-p)/m%1*255,s++}s-=v;for(let p=0;p<v;p++){let h=(c+s+p)*4;f[h+2]=f[h],f[h+3]=f[h+1]}}}u.uniforms.layoutSizeInChars.value.set(d/m,x),u.uniforms.layoutSizeInCharColumns.value.set(d,x),u.uniforms.layoutTexture.value=new Ee(f,d,x,De,Ge,Re,ue,ue,se,se),this._newFontString=void 0,this.onCharSizeUpdated&&this.onCharSizeUpdated(d/m,x)}}};updateText=(e="")=>{this.text=`${e}`};onRemove(){g(this.settings,"fontFace",this.onFontFaceChange),this._fontFace&&(g(this._fontFace,"texture",this.onFontTextureUpdate),g(this._fontFace,"font",this.onFontUpdate))}regenerateGeometry(){this.geometry=fe(this._text,this.settings),this.updateMeasurements()}updateMeasurements(){let e=this.geometry.boundingBox;this.width=e.max.x-e.min.x,this.height=Math.abs(e.max.y-e.min.y),this.userData.resolution=new w(this.width,this.height),this.onMeasurementsUpdated&&this.onMeasurementsUpdated(this)}},ke=t=>{let n={layoutTexture:new o(Y()),fontTexture:new o(t.fontFace.texture),color:new o(new ae(t.color)),strokeColor:new o(new ae(t.strokeColor)),fontSizeInChars:new o(new w(1,1)),layoutSizeInChars:new o(new w(1,1)),layoutSizeInCharColumns:new o(new w(1,1)),alignment:new o(new w(t.align,-t.vAlign))},e=n;if(t.screenSpace)if(e.prescale=new o(t.prescale),e.clipSpacePosition=new o(new Be),t.pixelSizeInClipSpaceUniform)e.pixelSizeInClipSpace=t.pixelSizeInClipSpaceUniform;else throw new Error("You must provide a pixelSizeInClipSpaceUniform for screenSpace mode");return new Ne({defines:{USE_SCREENSPACE:t.screenSpace,CONSTANT_SIZE_ON_SCREEN:t.constantSizeOnScreen},uniforms:n,vertexShader:oe,fragmentShader:K,depthWrite:!0})},he=new pe(.001,.001);he.computeBoundingBox();var q=new pe(1,1),xe=q.attributes.position,le=xe.array;for(let t=0;t<xe.count;t++){let n=t*3;le[n]+=.5,le[n+1]-=.5}q.computeBoundingBox();var fe=(t,n)=>n.fontFace.font&&t?q:he;export{H as default};
//# sourceMappingURL=index.js.map
