import{Color as ue,DataTexture as De,Matrix4 as Ge,Mesh as Ve,NearestFilter as ce,PlaneBufferGeometry as me,RGBAFormat as Be,RepeatWrapping as fe,Uniform as i,UnsignedByteType as Ne,UVMapping as We,Vector2 as P,Vector4 as je,RawShaderMaterial as ke}from"three";import{Plane as Y,Ray as be,Vector3 as D}from"three";var Ze=2*Math.PI,Je=180/Math.PI,Ke=Math.PI/180;var Qe=new be,et=new Y(new D(0,-1,0),1),tt=new Y(new D(0,-1,0),1),nt=new D;var rt=Math.PI*2,ot=Math.PI*3;var Se=(Math.sqrt(5)+1)*.5-1,it=Se*Math.PI*2;var Z=(t,n,e=!1)=>{let r=t.indexOf(n);if(r!==-1)t.splice(r,1);else if(e)throw new Error("could not find value in array");return n};var G=class{get listenerCount(){return this.listeners.length}obj;propName;value;listeners;constructor(n,e){this.propName=e,this.listeners=[],this.setValue=this.setValue.bind(this),this.attach(n)}attach(n){this.obj&&this.release(),this.obj=n;let e=this.obj[this.propName];Object.defineProperty(n,this.propName,{configurable:!0,set:this.setValue,get:()=>this.value}),this.setValue(e)}release(){Object.defineProperty(this.obj,this.propName,{value:this.value,writable:!0})}hasListener(n){return this.listeners.indexOf(n)!==-1}addListener(n,e=!0){e&&n(this.value,void 0),this.listeners.push(n)}removeListener(n){Z(this.listeners,n)}setValue(n){if(this.value===n)return;let e=this.value;this.value=n;for(let r of this.listeners)r(n,e)}},b=new Map;function we(t){return b.has(t)||b.set(t,new Map),b.get(t)}function Pe(t,n){let e=we(t);return e.has(n)||e.set(n,new G(t,n)),e.get(n)}function O(t,n,e,r=!0){Pe(t,n).addListener(e,r)}function T(t,n,e){let r=b.get(t);if(r){let o=r.get(n);o&&(o.removeListener(e),o.listenerCount===0&&(o.release(),r.delete(n))),r.size===0&&b.delete(t)}}import{DataTexture as _e,RGBAFormat as Me,UnsignedByteType as Ie}from"three";var V;function J(){if(!V){let e=new Uint8Array(64);for(let r=0;r<64;r++)e[r]=0;V=new _e(e,4,4,Me,Ie)}return V}var K="precision highp float;uniform sampler2D fontTexture;uniform sampler2D layoutTexture;uniform vec3 color;uniform vec3 strokeColor;uniform vec2 fontSizeInChars;varying vec2 vUv;varying vec2 vUvCharCols;void main(){vec4 layoutTexel=texture2D(layoutTexture,vec2(vUv.x,1.0-vUv.y));vec2 fontCharIndices=layoutTexel.xz*vec2(255.0001);vec4 layoutCharUv=fract(vUvCharCols).xyxy;layoutCharUv.xz=fract(layoutCharUv.xz-layoutTexel.yw);vec2 tA=mod(fontCharIndices,fontSizeInChars.x);vec2 tB=vec2(fontSizeInChars.y-1.0)-floor(fontCharIndices/fontSizeInChars.x);vec4 packedAB=vec4(tA.x,tB.x,tA.y,tB.y);vec4 fontCharIndexUv=(layoutCharUv+packedAB)/fontSizeInChars.xyxy;vec4 texel=texture2D(fontTexture,fontCharIndexUv.xy);vec4 texel2=texture2D(fontTexture,fontCharIndexUv.zw);vec4 final=max(texel,texel2);if(final.a<0.5)discard;vec3 finalColor=mix(strokeColor,color,final.r);gl_FragColor=vec4(finalColor.rgb,1.0);}";import{Color as h}from"three";var Q=new h(0),ee=new h(16777215),gt=new h(6750054),Tt=new h(2273279),te=new h(6750054),Ct=new h(16711680),yt=new h(16050242);import{NearestFilter as oe}from"three";import{FileLoader as Fe,LoadingManager as Ue,TextureLoader as Ee}from"three";var ne=new Ue,B;function Re(){return B||(B=new Fe(ne)),B}var N;function Le(){return N||(N=new Ee(ne)),N}async function W(t){return new Promise((n,e)=>Re().load(t,r=>n(r),void 0,e))}var S=new Map;async function re(t,n){let e;return S.has(t)?e=new Promise((r,o)=>{S.get(t).push(r)}):e=new Promise((r,o)=>{S.set(t,[r]);let F=C=>{C.name=t,n!==void 0&&(C.flipY=n),S.get(t).forEach(q=>q(C)),S.delete(t)};Le().load(t,F,void 0,o)}),e}function j(t,n){return`${t}.${n}`}var w=class{constructor(n,e=7,r=8){this.name=n;this.maxCharPixelWidth=e;this.charPixelHeight=r}font;pixelWidths;texture;_initd=!1;async init(){if(this._initd)return;this._initd=!0,this.texture=await re(j(this.name,"png")),this.texture.minFilter=oe,this.texture.magFilter=oe;let n=(await W(j(this.name+"_char-widths","txt"))).split(`
`).join(""),e=[];for(let r=0;r<n.length;r++)e[r]=parseInt(n[r]);this.pixelWidths=e,this.font=(await W(j(this.name,"txt"))).split(`
`).join("")}},ie={cdogs_font_7x8:new w("pixelFonts/cdogs_font_7x8",7,8),good_neighbors:new w("pixelFonts/good_neighbors",11,16)};var ae={fontFace:ie.cdogs_font_7x8,align:0,vAlign:0,color:ee,letterSpacing:-1,strokeColor:Q,scaleDownToPhysicalSize:!0,screenSpace:!1,constantSizeOnScreen:!1,prescale:1},Ae={...ae,color:te},se={generic:ae,title:Ae};var le=`uniform vec2 alignment;
#ifdef USE_SCREENSPACE
uniform float prescale;uniform vec4 clipSpacePosition;uniform vec2 pixelSizeInClipSpace;
#else
uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;
#endif
attribute vec3 position;attribute vec2 uv;varying vec2 vUv;varying vec2 vUvCharCols;uniform vec2 layoutSizeInChars;void main(){vUv=uv;vUvCharCols=uv*layoutSizeInChars;
#ifdef USE_SCREENSPACE
vec2 finalOffset=(position.xy-alignment)*pixelSizeInClipSpace*prescale*layoutSizeInChars;
#ifdef CONSTANT_SIZE_ON_SCREEN
finalOffset*=clipSpacePosition.w;
#endif
gl_Position=clipSpacePosition;gl_Position.xy+=finalOffset;
#else
vec3 pos=position;pos.xy-=alignment;gl_Position=projectionMatrix*modelViewMatrix*vec4(pos,1.0);
#endif
}`;var pe=new Ge,k=[];function He(t){if(!t)return-1;let n=k.indexOf(t);return n===-1?(k.push(t),k.length-1):n}var Xe=2048,H=class extends Ve{constructor(e="",r=se.generic,o,F,C=!0){super(he(e,r),qe(r));this._text=e;this.settings=r;this.onMeasurementsUpdated=o;this.onCharSizeUpdated=F;this.optimizeRenderOrder=C;O(r,"fontFace",this.onFontFaceChange,!0)}width=0;height=0;dirty=!1;livePropObject;livePropName;_fontFace;_newTexture;_newFontString;get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this.dirty=!0)}onFontFaceChange=(e,r)=>{r&&(T(r,"texture",this.onFontTextureUpdate),T(r,"font",this.onFontUpdate)),O(e,"texture",this.onFontTextureUpdate),O(e,"font",this.onFontUpdate),e.init(),this._fontFace=e};onFontTextureUpdate=e=>{this._newTexture=e,this.dirty=!0};onFontUpdate=e=>{this._newFontString=e,this.dirty=!0};onBeforeRender=(e,r,o,F,C,q)=>{if(this.settings.screenSpace){let l=this.material.uniforms.clipSpacePosition.value;pe.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld).premultiply(o.projectionMatrix),l.set(0,0,0,1).applyMatrix4(pe)}if(this.dirty){this.dirty=!1,this.regenerateGeometry();let l=this.material;if(this._newTexture&&(this.optimizeRenderOrder&&(this.renderOrder=this.renderOrder||100+He(this._newTexture)),l.uniforms.fontTexture.value=this._newTexture,this._newTexture=void 0),this._newFontString&&this._text){let U=this.text.split(`
`).slice(0,Xe),m=U.length,y=this.settings.fontFace,d=y.maxCharPixelWidth,E=y.font,R=y.pixelWidths,v=-this.settings.letterSpacing,$=l.uniforms.fontTexture.value.image;l.uniforms.fontSizeInChars.value.set($.width/y.maxCharPixelWidth,$.height/y.charPixelHeight);let L=E.indexOf("\u25A1");if(L===-1)throw new Error("Please include this character \u25A1 in your font, to stand in for other missing characters");let A="",Te=U.map(a=>{let u=0;for(let s=0;s<a.length;s++){let c=a[s];if(c==null)continue;let _=E.indexOf(c);_===-1?(u+=d-R[L]-v,A.includes(c)||(A+=c)):u+=d-R[_]-v}return u+v});console.warn("Characters in text not found in font: "+A);let g=Te.reduce((a,u)=>Math.max(a,u),0),Ce=g*m,f=new Uint8Array(Ce*4);for(let a=0;a<m;a++){let u=a*g,s=0,c=U[a],_=c.length;for(let M=0;M<=_;M++){let z=c[M],ye=c[M-1];if(!z&&!ye)continue;let I=E.indexOf(z);I===-1&&z!==void 0&&(I=L);let ve=d-R[I];for(let p=0;p<ve;p++){let x=(u+s)*4;f[x]=I,f[x+1]=(s-p)/d%1*255,s++}s-=v;for(let p=0;p<v;p++){let x=(u+s+p)*4;f[x+2]=f[x],f[x+3]=f[x+1]}}}l.uniforms.layoutSizeInChars.value.set(g/d,m),l.uniforms.layoutSizeInCharColumns.value.set(g,m),l.uniforms.layoutTexture.value=new De(f,g,m,Be,Ne,We,fe,fe,ce,ce),this._newFontString=void 0,this.onCharSizeUpdated&&this.onCharSizeUpdated(g/d,m)}}};updateText=(e="")=>{this.text=`${e}`};onRemove(){T(this.settings,"fontFace",this.onFontFaceChange),this._fontFace&&(T(this._fontFace,"texture",this.onFontTextureUpdate),T(this._fontFace,"font",this.onFontUpdate))}regenerateGeometry(){this.geometry=he(this._text,this.settings),this.updateMeasurements()}updateMeasurements(){let e=this.geometry.boundingBox;this.width=e.max.x-e.min.x,this.height=Math.abs(e.max.y-e.min.y),this.userData.resolution=new P(this.width,this.height),this.onMeasurementsUpdated&&this.onMeasurementsUpdated(this)}},qe=t=>{let n={layoutTexture:new i(J()),fontTexture:new i(t.fontFace.texture),color:new i(new ue(t.color)),strokeColor:new i(new ue(t.strokeColor)),fontSizeInChars:new i(new P(1,1)),layoutSizeInChars:new i(new P(1,1)),layoutSizeInCharColumns:new i(new P(1,1)),alignment:new i(new P(t.align,-t.vAlign))},e=n;if(t.screenSpace)if(e.prescale=new i(t.prescale),e.clipSpacePosition=new i(new je),t.pixelSizeInClipSpaceUniform)e.pixelSizeInClipSpace=t.pixelSizeInClipSpaceUniform;else throw new Error("You must provide a pixelSizeInClipSpaceUniform for screenSpace mode");return new ke({defines:{USE_SCREENSPACE:t.screenSpace,CONSTANT_SIZE_ON_SCREEN:t.constantSizeOnScreen},uniforms:n,vertexShader:le,fragmentShader:K,depthWrite:!0})},de=new me(.001,.001);de.computeBoundingBox();var X=new me(1,1),ge=X.attributes.position,xe=ge.array;for(let t=0;t<ge.count;t++){let n=t*3;xe[n]+=.5,xe[n+1]-=.5}X.computeBoundingBox();var he=(t,n)=>n.fontFace.font&&t?X:de;export{H as default};
//# sourceMappingURL=index.js.map
